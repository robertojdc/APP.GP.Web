<div class="container-fluid py-4">
    <!-- Clasificación Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header text-white text-center">
            <h3 class="mb-0">CLASIFICACIÓN</h3>
        </div>
        <div class="card-body">
            <form id="clasificacionForm" class="row g-3">
                <div class="col-md-4">
                    <label for="grupo" class="form-label">GRUPO</label>
                    <input id="grupo" name="grupo" class="form-control" placeholder="Seleccione un grupo">
                    <input type="hidden" id="grupoId" name="grupoId">
                </div>
                <div class="col-md-4">
                    <label for="subgrupo" class="form-label">SUBGRUPO</label>
                    <input id="subgrupo" name="subgrupo" class="form-control" placeholder="Seleccione un subgrupo">
                    <input type="hidden" id="subgrupoId" name="subgrupoId">
                </div>
                <div class="col-md-4">
                    <label for="clasificacion" class="form-label">CLASIFICACIÓN</label>
                    <input id="clasificacion" name="clasificacion" class="form-control" placeholder="Seleccione una clasificación">
                    <input type="hidden" id="clasificacionId" name="clasificacionId">
                </div>
            </form>
            <br />
            <div class="col-12 text-center">
                <button type="button" class="btn btn-danger w-10 mt-3" id="agregarCategoria">Agregar</button>
            </div>
            <br />
            <!-- Tabla de Categorías -->
            <div class="table-responsive mb-4">
                <table class="table table-striped table-hover" id="tablaCategorias" style="display:none;">
                    <thead class="table-dark">
                        <tr>
                            <th>Grupo</th>
                            <th>Subgrupo</th>
                            <th>Clasificación</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>



    <!-- Ficha Personal Section -->
    <div class="container-fluid py-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header text-white text-center">
                <h3 class="mb-0">FICHA PERSONAL</h3>
            </div>
            <div class="card-body bg-light">
                <form id="personalForm" class="row g-3" enctype="multipart/form-data">
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="Nombre" class="form-label">NOMBRE(S)</label>
                        <input name="Nombre" type="text" class="form-control" placeholder="Nombre(s)">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="ApellidoPaterno" class="form-label">APELLIDO PATERNO</label>
                        <input name="ApellidoPaterno" type="text" class="form-control" placeholder="Apellido paterno">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="ApellidoMaterno" class="form-label">APELLIDO MATERNO</label>
                        <input name="ApellidoMaterno" type="text" class="form-control" placeholder="Apellido materno">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="Foto" class="form-label">FOTO</label>
                        <input name="Foto" type="file" class="form-control">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="CargoActual" class="form-label">CARGO ACTUAL</label>
                        <input name="CargoActual" type="text" class="form-control" placeholder="Ingrese cargo actual">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="FechaNacimiento" class="form-label">FECHA DE NACIMIENTO</label>
                        <input name="FechaNacimiento" type="date" class="form-control">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="DomicilioLaboral" class="form-label">DOMICILIO LABORAL</label>
                        <input name="DomicilioLaboral" type="text" class="form-control" placeholder="Ingrese domicilio laboral">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="DomicilioParticular" class="form-label">DOMICILIO PARTICULAR</label>
                        <input name="DomicilioParticular" type="text" class="form-control" placeholder="Ingrese domicilio particular">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="TelefonoLaboral" class="form-label">TELÉFONO LABORAL</label>
                        <input name="TelefonoLaboral" type="tel" class="form-control" placeholder="Ingrese teléfono laboral">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="TelefonoPersonal" class="form-label">TELÉFONO PERSONAL</label>
                        <input name="TelefonoPersonal" type="tel" class="form-control" placeholder="Ingrese teléfono personal">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="CorreoElectronico" class="form-label">CORREO ELECTRÓNICO</label>
                        <input name="CorreoElectronico" type="email" class="form-control" placeholder="Ingrese correo electrónico">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="inputRedSocial" class="form-label">REDES SOCIALES</label>
                        <div class="input-group">
                            <input id="inputRedSocial" name="inputRedSocial" type="text" class="form-control" placeholder="Ingrese red social">
                            <button type="button" class="btn btn-primary" id="addRedSocial">Agregar</button>
                        </div>
                    </div>
                    <div class="col-12">
                        <table class="table table-bordered table-striped mt-2" id="tablaRedesSociales">
                            <thead class="table-dark">
                                <tr>
                                    <th>Red Social</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="PaginaWeb" class="form-label">PÁGINA WEB</label>
                        <input name="PaginaWeb" type="url" class="form-control" placeholder="Ingrese página web">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="Afinidad" class="form-label">AFINIDAD</label>
                        <input id="afinidad" name="Afinidad" class="form-control" placeholder="Ingrese afinidad">
                    </div>
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="Compromiso" class="form-label">COMPROMISO</label>
                        <input name="Compromiso" type="text" class="form-control" placeholder="Ingrese compromiso">
                    </div>
                    <div class="col-12">
                        <label for="Comentarios" class="form-label">COMENTARIOS</label>
                        <textarea name="Comentarios" class="form-control" placeholder="Ingrese comentarios"></textarea>
                    </div>
                    <div class="col-12 text-center mt-4">
                        <button type="button" class="btn btn-danger me-2" id="submitButton">Guardar</button>
                        <button type="button" class="btn btn-outline-secondary" id="regresarActor">Regresar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
@* 
<style>
    /* Colores basados en los Pantones proporcionados */
    :root {
        --color-primary: #9F2241; /* Pantone 7420 C */
        --color-secondary: #235B4E; /* Pantone 626 C */
        --color-accent: #DDC9A3; /* Pantone 468 C */
        --color-gray: #98989A; /* Pantone Cool Gray 7 C */
        --color-background: #F5F5F5; /* Fondo neutro para claridad */
    }

    body {
        background-color: var(--color-background);
    }

    .card-header {
        background-color: var(--color-primary);
        border-bottom: 2px solid var(--color-secondary);
    }

    .btn-danger {
        background-color: var(--color-primary);
        border-color: var(--color-primary);
        color: white;
    }

        .btn-danger:hover {
            background-color: #691C32; /* Un tono más oscuro para el hover */
            border-color: #691C32;
        }

    .btn-outline-secondary {
        border-color: var(--color-secondary);
        color: var(--color-secondary);
    }

        .btn-outline-secondary:hover {
            background-color: var(--color-secondary);
            color: white;
        }

    .table thead {
        /* background-color: var(--color-secondary); */
        color: white;
    }

    .table tbody tr:hover {
        background-color: var(--color-accent);
    }

    .form-label {
        color: var(--color-secondary);
    }

    .form-control:focus {
        border-color: var(--color-secondary);
        box-shadow: 0 0 0 0.2rem rgba(35, 91, 78, 0.25); /* Pantone 626 C */
    }
</style> *@
<script>

    let callDepth = 0;
    const MAX_CALL_DEPTH = 5;
    let isFetchingSubCategoria = false;

    $(document).ready(function () {
        $("#regresarActor").click(function (e) {
            e.preventDefault();
            window.location.href = '/Actor/Select';
        });
        obtenerAfinidad();
        $('#addRedSocial').on('click', function () {
            const redSocial = $('#inputRedSocial').val().trim();

            if (redSocial === '') {
                alert('Por favor, ingrese una red social.');
                return;
            }

            const nuevaFila = `
                                <tr>
                                    <td>
                                        <input type="hidden" name="RedesSociales[]" value="${redSocial}">
                                        ${redSocial}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm removeRedSocial">Eliminar</button>
                                    </td>
                                </tr>`;

            $('#tablaRedesSociales tbody').append(nuevaFila);

            $('#inputRedSocial').val('');
        });

        $(document).on('click', '.removeRedSocial', function () {
            $(this).closest('tr').remove();
        });

        $('#submitButton').on('click', function (e) {
            e.preventDefault();

            var formData = new FormData($('#personalForm')[0]);

            var categorias = [];
            $('#tablaCategorias tbody tr').each(function () {
                var grupoId = $(this).data('grupoid');
                var idSubGrupo = $(this).data('subgrupoid');
                var idCategoria = $(this).data('clasificacionid');
                var idSubcategoria = $(this).data('subcategoriaid');

                categorias.push({
                    IdGrupo: grupoId,
                    IdSubGrupo: idSubGrupo,
                    IdCategoria: idCategoria,
                    IdSubcategoria: idSubcategoria
                });
            });

            formData.append('categoriasJson', JSON.stringify(categorias));

            $.ajax({
                url: '/Actor/Create',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    MensajeExito('Guardado', 'Actor creado exitosamente!');

                    $('#tablaCategorias tbody').empty();

                    $('#personalForm')[0].reset();
                },
                error: function (xhr, status, error) {
                    alert('Ocurrió un error: ' + error);
                }
            });
        });

        $('#agregarCategoria').on('click', function (e) {
            e.preventDefault();
            debugger;
            var grupo = $('#grupo').data('kendoDropDownList').text();
            var grupoId = $('#grupo').data('kendoDropDownList').value();
            var subgrupo = $('#subgrupo').data('kendoDropDownList').text();
            var subgrupoId = $('#subgrupo').data('kendoDropDownList').value();
            var clasificacion = $('#clasificacion').data('kendoDropDownList').text();
            var clasificacionId = $('#clasificacion').data('kendoDropDownList').value();

            // Validar que todos los campos estén llenos
            if (!grupoId || !subgrupoId || !clasificacionId) {
                MensajeAdvertencia('Todos los campos deben estar llenos y seleccionados correctamente.');
                return;
            }

            // Obtener los inputs en la subcategoria-container
            var subcategoriaInputs = $('.subcategoria-container input');
            var ultimaSubcategoria = subcategoriaInputs.last(); // Obtener el último input

            // Si el último input no tiene valor seleccionado, usar el penúltimo
            if (!ultimaSubcategoria.data('kendoDropDownList') || !ultimaSubcategoria.data('kendoDropDownList').value()) {
                ultimaSubcategoria = subcategoriaInputs.eq(-2); // Cambiar al penúltimo input si el último no está seleccionado
            }

            var subcategoriaText = '';
            var subcategoriaId = '';

            if (ultimaSubcategoria.data('kendoDropDownList') != null) {
                subcategoriaText = ultimaSubcategoria.data('kendoDropDownList').text();
                subcategoriaId = ultimaSubcategoria.data('kendoDropDownList').value();
            }

            // Crear la nueva fila con o sin subcategoría
            var nuevaFila = `
                <tr data-grupoid="${grupoId}" data-subgrupoid="${subgrupoId}" data-clasificacionid="${clasificacionId}" ${subcategoriaId ? `data-subcategoriaid="${subcategoriaId}"` : ''}>
                    <td>${grupo}</td>
                    <td>${subgrupo}</td>
                    <td>${subcategoriaId ? subcategoriaText : clasificacion}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm eliminarFila">Eliminar</button>
                    </td>
                </tr>
            `;

            $('#tablaCategorias tbody').append(nuevaFila);

            // Mostrar la tabla y limpiar los campos
            $("#tablaCategorias").show();
            $('#grupo').data('kendoDropDownList').value('');
            $('#subgrupo').data('kendoDropDownList').value('');
            $('#clasificacion').data('kendoDropDownList').value('');
            $('#grupoId').val('');
            $('#subgrupoId').val('');
            $('#clasificacionId').val('');

            // Eliminar las subcategorías para evitar duplicados
            $('.subcategoria-container').remove();
        });



        $(document).on('click', '.eliminarFila', function () {
            $(this).closest('tr').remove();
        });

        obtenerGrupos();
    });

    function obtenerAfinidad() {
        $.ajax({
            url: '/Actor/GetAfinidades',
            type: 'GET',
            success: function (response) {
                $("#afinidad").kendoDropDownList({
                    dataTextField: "nombre",
                    dataValueField: "id",
                    dataSource: response,
                    optionLabel: "Seleccione una afinidad"
                });
            },
            error: function (xhr, status, error) {
                console.log('Ocurrió un error: ' + error);
            }
        });
    }

    function obtenerGrupos() {
        $.ajax({
            url: '/Actor/ObtenerGrupos',
            type: 'GET',
            success: function (response) {
                $("#grupo").kendoDropDownList({
                    dataTextField: "nombre",
                    dataValueField: "id",
                    dataSource: response,
                    optionLabel: "Seleccione un grupo",
                    change: function (e) {
                        var idGrupo = this.value();
                        limpiarSubcategorias();
                        if (idGrupo) {
                            reiniciarDropdown("#subgrupo");
                            reiniciarDropdown("#clasificacion");
                            obtenerSubGrupos(idGrupo);
                        } else {
                            reiniciarDropdown("#subgrupo");
                            reiniciarDropdown("#clasificacion");
                        }
                    }
                });
            },
            error: function (xhr, status, error) {
                console.log('Ocurrió un error: ' + error);
            }
        });
    }

    function reiniciarDropdown(selector) {
        const dropdown = $(selector).data("kendoDropDownList");

        if (dropdown) {
            dropdown.dataSource.data([]);
            dropdown.value('');
        } else {
            console.log(`El dropdown ${selector} no está inicializado o no se encontró.`);
        }
    }

    function limpiarSubcategorias() {
        $('.subcategoria-container').remove();
    }

    function obtenerSubGrupos(idGrupo) {
        $.ajax({
            url: '/Actor/ObtenerSubGrupos',
            type: 'POST',
            data: { idGrupo: idGrupo },
            success: function (response) {
                $("#subgrupo").kendoDropDownList({
                    dataTextField: "nombre",
                    dataValueField: "id",
                    dataSource: response,
                    optionLabel: "Seleccione un subgrupo",
                    change: function (e) {
                        var idSubGrupo = this.value();
                        if (idSubGrupo) {
                            obtenerCategoria(idSubGrupo);
                        }
                    }
                });
            },
            error: function (xhr, status, error) {
                console.log('Ocurrió un error: ' + error);
            }
        });
    }

    function obtenerCategoria(idSubGrupo) {
        // Eliminar subcategorías previas antes de agregar nuevas
        limpiarSubcategorias();

        $.ajax({
            url: '/Actor/ObtenerCategorias',
            type: 'POST',
            data: { idSubGrupo: idSubGrupo },
            success: function (response) {
                $("#clasificacion").kendoDropDownList({
                    dataTextField: "descripcion",
                    dataValueField: "idCategoria",
                    dataSource: response,
                    optionLabel: "Seleccione una clasificación",
                    change: function (e) {
                        var idSubCategoria = this.value();
                        if (idSubCategoria) {
                            // Limpiar subcategorías anteriores
                            limpiarSubcategorias();
                            obtenerSubCategoria(idSubCategoria);
                        }
                    }
                });
            },
            error: function (xhr, status, error) {
                console.log('Ocurrió un error: ' + error);
            }
        });
    }


    function obtenerSubCategoria(idSubCategoria) {
        if (isFetchingSubCategoria || callDepth >= MAX_CALL_DEPTH) {
            console.log('Se detuvo la recursión para evitar un ciclo infinito.');
            return;
        }

        isFetchingSubCategoria = true;
        callDepth++;

        $.ajax({
            url: '/Actor/ObtenerSubCategorias',
            type: 'POST',
            data: { idCategoria: idSubCategoria },
            success: function (response) {
                isFetchingSubCategoria = false;

                if (!response || response.length === 0) {
                    console.log('No se encontraron subcategorías.');
                    return;
                }

                // Crear un contenedor con la misma estructura que tu formulario
                const subCategoriaContainer = $('<div class="col-md-4 subcategoria-container">')
                    .append('<label for="subcategoria' + idSubCategoria + '" class="form-label">SUBCATEGORÍA</label>')
                    .append('<input id="subcategoria' + idSubCategoria + '" name="subcategoria" class="form-control" placeholder="Seleccione una subcategoría">');

                // Insertar el contenedor en el formulario
                $('#clasificacionForm').append(subCategoriaContainer);

                // Inicializar el KendoDropDownList para el nuevo input de subcategoría
                $("#subcategoria" + idSubCategoria).kendoDropDownList({
                    dataTextField: "descripcion",
                    dataValueField: "idCategoria",
                    dataSource: response,
                    optionLabel: "Seleccione una subcategoría",
                    change: function (e) {
                        const newSubCategoriaId = this.value();

                        if (newSubCategoriaId && newSubCategoriaId !== idSubCategoria) {
                            obtenerSubCategoria(newSubCategoriaId);
                        }
                    }
                });
            },
            error: function (xhr, status, error) {
                isFetchingSubCategoria = false;
                console.log('Ocurrió un error: ' + error);
            },
            complete: function () {
                callDepth--;
            }
        });
    }

</script>
